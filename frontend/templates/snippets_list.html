{% for result in result_set.merged_results %}
  <div class='snippet {% cycle row_highlight,row_plain %}'>
    <table>
    <tr>
    <td valign='top'>
    <div class='snippet_buttons'>
      <div class='snippet_button {% if result.interest %} starred {% else %} unstarred {% endif %}'
           onclick='toggleInterest(this, "{{result.id|escape}}",
                                          "{{result.base_url|escape}}")'>
      </div>

      <!-- TODO(doll): Add to calendar functions need dates in the right format -->
      <div class='snippet_button'
           onclick='addToCalendar(this, "YAHOO", "{{result.url|escape}}",
                                  "{{result.js_escaped_title|escape}}",
                                  "{{result.js_escaped_snippet|escape}}",
                                  "20090214", "{{result.location}}")'>
        <img src='images/Event-AddToCalendar.png' height="16px" alt='Yahoo! Calendar'/>
      </div>
      <div class='snippet_button'
           onclick='addToCalendar(this, "GOOGLE", "{{result.url|escape}}",
                                  "{{result.js_escaped_title|escape}}",
                                  "{{result.js_escaped_snippet|escape}}",
                                  "20090214", "{{result.location}}")'>
        <img src='images/Event-AddToCalendar.png' height="16px" alt='Google Calendar'/>
      </div>
      <div class='snippet_button' id='addthis{{ forloop.counter0 }}'>
        <a _orig_addthis_href="http://www.addthis.com/bookmark.php?v=20"
           href="javascript:addthis_open(this, '', '{{result.url|escape}}', '{{result.js_escaped_title|escape}}');void(0);"
           onmouseover="return addthis_open(this, '', '{{result.url|escape}}', '{{result.js_escaped_title|escape}}')"
           onmouseout="addthis_close()"
           _orig_addthis__onclick="return addthis_sendto()"
           onclick="return addthis_open(this, '', '{{result.url|escape}}', '{{result.js_escaped_title|escape}}')" >
          <img src="/images/Event-Share.png" width="16" height="16" alt="Bookmark and Share" style="border:0"/>
        </a>
      </div>

    </div>
    </td>
    <td valign='top'>
    <div>
      {# TODO(paul): ESCAPE THE LOCATION FIELD AGAINST QUOTES #}
      {% if location %}
        <script type='text/javascript'>
           asyncLoadManager.addCallback('map', function(){
               map.addMarkerGeocode("{{ result.location }}")});
        </script>
      {% endif %}
      {# TODO(oansaldi): escape dates for extra-care (they are already safe) #}
      {% if result.startdate %}
        <script>
          asyncLoadManager.addCallback('bodyload', function() {
            calendar.markRange(
                new Date('{{ result.startdate|date:"r" }}'),
                new Date('{{ result.enddate|date:"r" }}'));
          });
        </script>
      {% endif %}

      <div class='snippet_title'>
        <a href='{{ result.url }}'>{{ result.title }}</a>
      </div>
      {% if result.location or result.startdate or result.interest_count %}
        <div class='snippet_sub_text'>
          {{ result.location }}
          {% if result.location %}-{% endif %}
          {{ result.startdate|date:"m/d/Y" }}
          {% ifnotequal result.startdate.date result.enddate.date %}
          - {{ result.enddate|date:"m/d/Y" }}
          {% endifnotequal %}
          {% if result.interest_count %}
            {% if result.location or result.startdate %}-{% endif %}
            <img src="images/Event-StarredByOthers.png" alt="Starred"/> by {{result.interest_count}}
            {{ result.interest_count|pluralize:"person,people" }}
          {% endif %}
        </div>
      {% endif %}
      {% if result.have_more %}
<div class="snippet_sub_text" style="display:inline">
      {% endif %}
      {% for entry in result.less_list %}{{ entry }}{% endfor %}
      {% if result.have_more %}
<div id="{{ result.more_id }}" style="display:none;">
      {% for entry in result.more_list %}{{ entry }}{% endfor %}
<div onclick="showLessDuplicates('{{ result.more_id }}')" class="more_link"> show fewer locations and times...</div>
</div>
<span id="s{{ result.more_id }}" onclick="showMoreDuplicates('{{ result.more_id }}')" class="more_link"> more locations and times...</span>
</div>
      {% endif %}
      <div class='snippet_text'>
        {{ result.snippet }}
      </div>
      <div class='snippet_url'>
        <a href='{{ result.url }}'>{{ result.url_short }}</a>
      </div>
    </div>
    </td>
    </tr>
    </table>
  </div>
{% endfor %}
<script>
  asyncLoadManager.addCallback('bodyload', function() {
    calendar.render();
  });
</script>
